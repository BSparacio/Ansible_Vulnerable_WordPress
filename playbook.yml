---
# =============================================================================
# Main Playbook - WordPress Multi-Server Deployment
# =============================================================================
#
# This playbook deploys a 3-tier WordPress stack:
#
# [Web Server] (NGINX)
# [WordPress Server] (PHP + WP)
# [Database Server] (MYSQL)
# =============================================================================

# This runs on servers in the [database] group.
- name: Configure Database Server
  hosts: database
  become: true  # Run as root (sudo)
  tags: mysql

  roles:
    - mysql

# This runs on servers in the [wordpress] group.
# Idempotency is retained through conditional checks to see if wordpress is
# already installed.
# For a clean install, the directory is recreated and files are downloaded again
- name: Configure WordPress Server
  hosts: wordpress
  become: true
  tags: wordpress

  pre_tasks:
    - name: Check if WordPress is currently installed
      ansible.builtin.stat:
        path: /var/www/wordpress/wp-config.php
      register: wp_config_check

    - name: Remove existing WordPress directory
      ansible.builtin.file:
        path: /var/www/wordpress
        state: absent
      when: not wp_config_check.stat.exists

    - name: Recreate empty WordPress directory
      ansible.builtin.file:
        path: /var/www/wordpress
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
      when: not wp_config_check.stat.exists

  roles:
    - wordpress

# Configures the WordPress webpage by:
# - Installing and verifying the WP-CLI package
# - Installs WordPress Core and signs in
# - Enables vulnerabilities on WordPress such as Allow Unfiltered Uploads
# - Create a folder to hold theme information and funcion.php file for database queries
# - Creates the front end of WordPress app including the Search Box UI (index.php)
# - Creates the backend of the Wordpress Vulnerable API (functions.php)
  post_tasks:
    - name: Download WP-CLI
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
        dest: "/usr/local/bin/wp"
        mode: '0755'

    - name: Verify WP-CLI installation
      ansible.builtin.command: "/usr/local/bin/wp --info"
      register: wpcli_info
      changed_when: false

    - name: Check if WordPress is already installed
      ansible.builtin.command: wp core is-installed --path=/var/www/wordpress
      become_user: www-data
      register: wp_is_installed
      failed_when: false
      changed_when: false

    # 3. Run the "5-Minute Install" automatically (Sets title, admin user, etc.)
    - name: Install WordPress Core
      ansible.builtin.command: >
        wp core install
        --path=/var/www/wordpress
        --url="{{ target_ip_address }}"
        --title="Welcome to the EchoFrame Database"
        --admin_user="{{ wordpress_admin_user }}"
        --admin_password="{{ wordpress_admin_password }}"
        --admin_email="{{ wordpress_admin_email }}"
      become_user: www-data
      when: wp_is_installed.rc != 0
      changed_when: true

    - name: Allow Unfiltered Uploads
      ansible.builtin.lineinfile:
        path: /var/www/wordpress/wp-config.php
        line: "define( 'ALLOW_UNFILTERED_UPLOADS', true );"
        insertafter: "define( 'DB_COLLATE', '' );"
        state: present
      become_user: www-data

    - name: Create Neon Pulse theme directory
      ansible.builtin.file:
        path: /var/www/wordpress/wp-content/themes/neon
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create Index.php with Robust API URL
      ansible.builtin.copy:
        dest: /var/www/wordpress/wp-content/themes/neon/index.php
        owner: www-data
        group: www-data
        mode: '0644'
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>CTF Terminal</title>
          </head>
          <body>
              <div class="main-container">
                  <h1>>> MAELSTROM_DATA_LINK_V.4.0</h1>
                  <p>Target Asset: <strong>ARASAKA SUBNET 04 (COMPROMISED)</strong></p>
                  <p style="font-size: 0.8em; color: #ff0055;">STATUS: CORP ICE BROKEN // DATA IS FREE</p>

                  <input type="text" id="db_query" placeholder="Enter_Arasaka_ID..." onkeydown="if(event.key==='Enter') runExploit()">
                  <button onclick="runExploit()">EXECUTE</button>

                  <div id="results">Awaiting query parameters...</div>
              </div>

              <script>
                  function runExploit() {
                      var input = document.getElementById('db_query').value;
                      var resultBox = document.getElementById('results');
                      resultBox.innerHTML = "Bypassing Arasaka Firewalls... Searching Node...";
                      resultBox.style.color = "#0f0";

                      fetch('/index.php?rest_route=/ctf/v1/search&q=' + encodeURIComponent(input))
                          .then(response => response.text())
                          .then(text => {
                              try {
                                  const data = JSON.parse(text);
                                  resultBox.innerHTML = "<strong>>> DATA RETRIEVED:</strong><br><pre>" + JSON.stringify(data, null, 2) + "</pre>";
                              } catch (e) {
                                  resultBox.style.color = "#ff00ff";
                                  resultBox.innerText = "RAW SERVER OUTPUT:\n" + text;
                              }
                          })
                          .catch(error => {
                              resultBox.innerHTML = "NETWORK ERROR (ARASAKA TRACE DETECTED): " + error;
                          });
                  }
              </script>
              <?php wp_footer(); ?>
          </body>
          </html>

    - name: Create functions.php with SQL Injection Vulnerability
      ansible.builtin.copy:
        dest: /var/www/wordpress/wp-content/themes/neon/functions.php
        owner: www-data
        group: www-data
        mode: '0644'
        content: |
          <?php
          add_action('rest_api_init', function () {
              register_rest_route('ctf/v1', '/search', [
                  'methods' => 'GET',
                  'callback' => 'ctf_sqli_search',
                  'permission_callback' => '__return_true',
              ]);
          });

          function ctf_sqli_search($request) {
              global $wpdb;
              $term = $request['q'];
              // VULNERABLE QUERY
              $query = "SELECT * FROM wp_users WHERE user_login LIKE '%" . $term . "%'";
              $results = $wpdb->get_results($query);
              return rest_ensure_response($results);
          }

    - name: Flush Permalinks (Fix API 404s)
      ansible.builtin.command: wp rewrite structure '/%postname%/' --path=/var/www/wordpress
      become_user: www-data
      changed_when: true

# This runs on servers in the [webserver] group.
- name: Configure Web Server
  hosts: webserver
  become: true
  tags: nginx

  roles:
    - nginx
