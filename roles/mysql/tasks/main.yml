---
# =============================================================================
# MySQL Database Server Setup
# =============================================================================
# This role installs MySQL and creates a database for WordPress.
#
# After completing this role, you will have:
# - MySQL server installed and running
# - A root password set (idempotently — safe to re-run)
# - A dedicated WordPress database and user
# - MySQL listening on all interfaces for remote connections
# =============================================================================


# Install the MySQL server package. The apt module handles package management.
- name: Install MySQL server
  ansible.builtin.apt:
    name: mysql-server
    state: present
    update_cache: true

# Ansible needs a Python library to talk to MySQL.
- name: Install Python MySQL library (required for Ansible)
  ansible.builtin.apt:
    name: python3-pymysql
    state: present

# The service module ensures MySQL is running now and configures automatic start
# on boot.
- name: Start and enable MySQL service
  ansible.builtin.service:
    name: mysql
    state: started
    enabled: true

# Set the root password idempotently
# - check_implicit_admin: true — on a fresh install, MySQL root has no password,
#   so the module first tries logging in without one.
# - login_user / login_password — credentials for subsequent runs when the
#   password is already set.
- name: Set MySQL root password
  community.mysql.mysql_user:
    name: root
    login_user: root
    login_password: "{{ mysql_root_password }}"
    password: "{{ mysql_root_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    check_implicit_admin: true
    state: present

# Create the WordPress database. The mysql_db module is idempotent — if the
# database already exists, Ansible reports "ok" and moves on.
- name: Create WordPress database
  community.mysql.mysql_db:
    name: "{{ wordpress_db_name }}"
    state: present
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock

# Create a dedicated MySQL user for WordPress with privileges limited to the
# WordPress database only.
- name: Create WordPress database user
  community.mysql.mysql_user:
    name: "{{ wordpress_db_user }}"
    password: "{{ wordpress_db_password }}"
    priv: "{{ wordpress_db_name }}.*:ALL"
    host: "{{ wordpress_server }}"
    state: present
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock

# Change bind-address to 0.0.0.0 so the WordPress server can connect over the
# network.
# Notify triggers the Restart MySQL handler only when this line changes.
- name: Configure MySQL to accept remote connections
  ansible.builtin.lineinfile:
    path: /etc/mysql/mysql.conf.d/mysqld.cnf
    regexp: '^bind-address'
    line: 'bind-address = 0.0.0.0'
  notify: Restart MySQL

# Create the table (Using ROOT credentials).
- name: Create wp_flags table for CTF
  community.mysql.mysql_query:
    login_db: "{{ wordpress_db_name }}"
    # CHANGE 1: Use root user
    login_user: "{{ mysql_root_user }}"
    # CHANGE 2: Use the root password variable from all.yml
    login_password: "{{ mysql_root_password }}"
    query: "CREATE TABLE IF NOT EXISTS wp_flags (id INT, flag VARCHAR(100), PRIMARY KEY (id)) DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_520_ci;"

# Insert the flag into the new table (Using ROOT credentials).
- name: Insert CTF Flag
  community.mysql.mysql_query:
    login_db: "{{ wordpress_db_name }}"
    login_user: "{{ mysql_root_user }}"
    login_password: "{{ mysql_root_password }}"
    query: "INSERT INTO wp_flags (id, flag) VALUES (1, 'flag{shattered_by_maelstrom}') ON DUPLICATE KEY UPDATE flag='flag{shattered_by_maelstrom}';"

# Misconfiguration so that web user can see and query the table.
- name: Grant WP User Access to Flag Table
  community.mysql.mysql_query:
    login_db: "{{ wordpress_db_name }}"
    login_user: "{{ mysql_root_user }}"
    login_password: "{{ mysql_root_password }}"
    query: "GRANT SELECT ON {{ wordpress_db_name }}.wp_flags TO '{{ wordpress_db_user }}'@'{{ wordpress_server }}'"
