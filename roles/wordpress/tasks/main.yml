---
# =============================================================================
# WordPress Application Server Setup
# =============================================================================
# This role installs WordPress with PHP on the application server.
#
# After completing this role, you will have:
# - PHP and required extensions installed
# - WordPress downloaded and configured
# - WordPress connected to the MySQL database from Session 1
#
# VARIABLES AVAILABLE TO YOU:
# - {{ wordpress_db_name }}       - Database name
# - {{ wordpress_db_user }}       - Database username
# - {{ wordpress_db_password }}   - Database password
# - {{ database_server }}         - IP of the MySQL server
# - {{ wordpress_install_dir }}   - Where to install WordPress
# - {{ php_packages }}            - List of PHP packages to install
# =============================================================================

# -----------------------------------------------------------------------------
# TASK 1: Install PHP and Required Extensions
# -----------------------------------------------------------------------------
# WordPress is written in PHP, so we need to install PHP and extensions.
# We'll install multiple packages at once using a list variable.
#
# HINT: Use the 'apt' module with a variable for the package list
# - name: "{{ php_packages }}" (this is a list defined in group_vars)
# - state: present
# - update_cache: yes
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html

- name: Install PHP and extensions
  ansible.builtin.apt:
    name: "{{ php_packages }}"
    state: present
    update_cache: true

# -----------------------------------------------------------------------------
# TASK 2: Create WordPress installation directory
# -----------------------------------------------------------------------------
# We need a directory to put WordPress files in.

- name: Create WordPress directory
  ansible.builtin.file:
    path: "{{ wordpress_install_dir }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

# -----------------------------------------------------------------------------
# TASK 3: Download WordPress
# -----------------------------------------------------------------------------
# Download the latest WordPress from wordpress.org
#
# HINT: Use the 'get_url' module
# - url: "{{ wordpress_download_url }}"
# - dest: /tmp/wordpress.tar.gz
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html

- name: Download WordPress
  ansible.builtin.get_url:
    url: "{{ wordpress_download_url }}"
    dest: /tmp/wordpress.tar.gz
    mode: '0644'

# -----------------------------------------------------------------------------
# TASK 4: Extract WordPress
# -----------------------------------------------------------------------------
# Unpack the downloaded archive into our installation directory.
#
# HINT: Use the 'unarchive' module
# - src: /tmp/wordpress.tar.gz
# - dest: "{{ wordpress_install_dir }}"
# - remote_src: yes (the file is on the remote server, not our laptop)
# - extra_opts: ["--strip-components=1"] (removes the wordpress/ folder layer)
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/unarchive_module.html

- name: Extract WordPress
  ansible.builtin.unarchive:
    src: /tmp/wordpress.tar.gz
    dest: "{{ wordpress_install_dir }}"
    remote_src: true
    extra_opts: ["--strip-components=1"]

# -----------------------------------------------------------------------------
# TASK 5: Configure WordPress (wp-config.php)
# -----------------------------------------------------------------------------
# WordPress needs a config file to know how to connect to the database.
# We use a TEMPLATE that Ansible fills in with our variables!
#
# HINT: Use the 'template' module
# - src: wp-config.php.j2 (the template file in this role's templates/ folder)
# - dest: "{{ wordpress_install_dir }}/wp-config.php"
# - owner: www-data
# - group: www-data
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html

- name: Configure WordPress
  ansible.builtin.template:
    src: wp-config.php.j2
    dest: "{{ wordpress_install_dir }}/wp-config.php"
    owner: www-data
    group: www-data
    mode: '0640'

# -----------------------------------------------------------------------------
# TASK 6: Set WordPress file ownership
# -----------------------------------------------------------------------------
# The web server (www-data user) needs to own the WordPress files.
#
# HINT: Use the 'file' module with recurse
# - path: "{{ wordpress_install_dir }}"
# - owner: www-data
# - group: www-data
# - recurse: yes (apply to all files inside)
#
# DOCUMENTATION: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html

- name: Set WordPress file ownership
  ansible.builtin.file:
    path: "{{ wordpress_install_dir }}"
    owner: www-data
    group: www-data
    recurse: true

# -----------------------------------------------------------------------------
# TASK 7: Configure PHP-FPM to listen on network
# -----------------------------------------------------------------------------
# PHP-FPM needs to accept connections from the Nginx server.

- name: Configure PHP-FPM to listen on all interfaces
  ansible.builtin.lineinfile:
    path: /etc/php/8.3/fpm/pool.d/www.conf
    regexp: '^listen = '
    line: 'listen = 0.0.0.0:9000'
  notify: Restart PHP-FPM

- name: Ensure PHP-FPM is running
  ansible.builtin.service:
    name: php8.3-fpm
    state: started
    enabled: true

- name: Fill database with Cyberpunk users
  ansible.builtin.shell: |
    if ! wp user get "$WP_USER" --field=login --path=/var/www/wordpress > /dev/null 2>&1; then
      wp user create "$WP_USER" "$WP_EMAIL" --role="$WP_ROLE" --user_pass="$WP_PASS" --path=/var/www/wordpress
      echo "changed"
    else
      echo "exists"
    fi
  args:
    executable: /bin/bash
  # This safely passes the variables into the shell environment
  environment:
    WP_USER: "{{ item.user }}"
    WP_EMAIL: "{{ item.email }}"
    WP_ROLE: "{{ item.role }}"
    WP_PASS: "{{ item.pass }}"
  register: user_creation_result
  changed_when: "'changed' in user_creation_result.stdout"
  become_user: www-data
  loop:
    - { user: 'johnny_silverhand', email: 'samurai@nightcity.net', role: 'editor', pass: 'ChippinIn2077!' }
    - { user: 'jackie_welles', email: 'jackie@heywood.com', role: 'author', pass: 'MamaWellesRecipe' }
    - { user: 'judy_alvarez', email: 'judy@mox.com', role: 'editor', pass: 'GhostInTheShell' }
    - { user: 'panam_palmer', email: 'panam@aldocaldos.com', role: 'author', pass: 'QueenOfTheHighway' }
    - { user: 'adam_smasher', email: 'arasaka@security.corp', role: 'subscriber', pass: 'YouLookLikeACutOfMeat' }
    - { user: 'goro_takemura', email: 'goro@arasaka.net', role: 'subscriber', pass: 'GoodYakitori' }
