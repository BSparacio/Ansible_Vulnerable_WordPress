---
# =============================================================================
# WordPress Application Server Setup
# =============================================================================
# This role installs WordPress with PHP on the application server.
#
# After completing this role, you will have:
# - PHP and required extensions installed
# - WordPress downloaded and configured
# - WordPress connected to the MySQL database
# - PHP-FPM listening on the network for Nginx to connect
# =============================================================================

# Install PHP and all extensions WordPress needs.
- name: Install PHP and extensions
  ansible.builtin.apt:
    name: "{{ php_packages }}"
    state: present
    update_cache: true

# -----------------------------------------------------------------------------
# DYNAMIC PHP VERSION DETECTION (The Fix)
# -----------------------------------------------------------------------------
- name: Detect installed PHP version directory
  ansible.builtin.shell: ls /etc/php/ | sort -V | tail -n 1
  register: php_version_detected
  changed_when: false

- name: Set PHP configuration path variable
  ansible.builtin.set_fact:
    php_fpm_pool_path: "/etc/php/{{ php_version_detected.stdout }}/fpm/pool.d/www.conf"
    php_fpm_service_name: "php{{ php_version_detected.stdout }}-fpm"

# Create a target directory to extract files into it.
- name: Create WordPress directory
  ansible.builtin.file:
    path: "{{ wordpress_install_dir }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

# Download the WordPress tarball from wordpress.org.
- name: Download WordPress
  ansible.builtin.get_url:
    url: "{{ wordpress_download_url }}"
    dest: /tmp/wordpress.tar.gz
    mode: '0644'

# Extract WordPress into the install directory.
# - remote_src: true — the archive is already on the server (from get_url)
# - extra_opts: ["--strip-components=1"] — the tarball contains a wordpress/
#   subdirectory; this strips it so files land directly in wordpress_install_dir
# - creates: — if wp-settings.php already exists, skip extraction entirely.
- name: Extract WordPress
  ansible.builtin.unarchive:
    src: /tmp/wordpress.tar.gz
    dest: "{{ wordpress_install_dir }}"
    remote_src: true
    extra_opts: ["--strip-components=1"]

# Deploy wp-config.php from a Jinja2 template. Ansible fills in database
# credentials from our variables file.
# Permissions are restricted (0640) because this file contains passwords.
- name: Configure WordPress
  ansible.builtin.template:
    src: wp-config.php.j2
    dest: "{{ wordpress_install_dir }}/wp-config.php"
    owner: www-data
    group: www-data
    mode: '0640'

# Ensure all WordPress files are owned by the www-data user so PHP-FPM
# can read and write them as needed.
- name: Set WordPress file ownership
  ansible.builtin.file:
    path: "{{ wordpress_install_dir }}"
    owner: www-data
    group: www-data
    recurse: true


# PHP-FPM defaults to listening on a Unix socket.
# PHP-FPM needs to accept connections from the Nginx server.
# Listen on TCP port 9000 so the Nginx server can connect
# over the network.
- name: Configure PHP-FPM to listen on all interfaces
  ansible.builtin.lineinfile:
    path: "{{ php_fpm_pool_path }}"
    regexp: '^listen = '
    line: 'listen = 0.0.0.0:9000'
  notify: Restart PHP-FPM

- name: Ensure PHP-FPM is running
  ansible.builtin.service:
    name: "{{ php_fpm_service_name }}"
    state: restarted
    enabled: true

# Populate the database with fake users. Idempotency is
# retained through a conditional check using the wp user get
# command inside a shell script.
# - wp user get "$WP_USER" command checks if the WordPress
#   user already exists.
# - changed_when: "'changed' in user_creation_result.stdout"
#   ensures the task is marked as "changed" only when a new
#   user is created.
- name: Fill database with Cyberpunk users
  ansible.builtin.shell: |
    if ! wp user get "$WP_USER" --field=login --path=/var/www/wordpress > /dev/null 2>&1; then
      wp user create "$WP_USER" "$WP_EMAIL" --role="$WP_ROLE" --user_pass="$WP_PASS" --path=/var/www/wordpress
      echo "changed"
    else
      echo "exists"
    fi
  args:
    executable: /bin/bash
  environment:
    WP_USER: "{{ item.user }}"
    WP_EMAIL: "{{ item.email }}"
    WP_ROLE: "{{ item.role }}"
    WP_PASS: "{{ item.pass }}"
  register: user_creation_result
  changed_when: "'changed' in user_creation_result.stdout"
  become_user: www-data
  loop:
    - { user: 'johnny_silverhand', email: 'samurai@nightcity.net', role: 'editor', pass: 'ChippinIn2077!' }
    - { user: 'jackie_welles', email: 'jackie@heywood.com', role: 'author', pass: 'MamaWellesRecipe' }
    - { user: 'judy_alvarez', email: 'judy@mox.com', role: 'editor', pass: 'GhostInTheShell' }
    - { user: 'panam_palmer', email: 'panam@aldocaldos.com', role: 'author', pass: 'QueenOfTheHighway' }
    - { user: 'adam_smasher', email: 'arasaka@security.corp', role: 'subscriber', pass: 'YouLookLikeACutOfMeat' }
    - { user: 'goro_takemura', email: 'goro@arasaka.net', role: 'subscriber', pass: 'GoodYakitori' }
